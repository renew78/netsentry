services:
  # MongoDB - Database for switches and devices
  mongodb:
    image: mongo:7-jammy
    container_name: netsentry_mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
    volumes:
      - mongodb_data:/data/db
    networks:
      - netsentry
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # InfluxDB - Time Series Database
  influxdb:
    image: influxdb:2.7-alpine
    container_name: netsentry_influxdb
    restart: unless-stopped
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUX_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ORG=network-monitoring
      - DOCKER_INFLUXDB_INIT_BUCKET=traffic
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUX_TOKEN}
    networks:
      - netsentry
    healthcheck:
      test: ["CMD", "influx", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Redis - Caching and Real-time State
  redis:
    image: redis:7-alpine
    container_name: netsentry_redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    networks:
      - netsentry
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # NetFlow/sFlow Collector
  collector:
    image: renew78/netsentry-collector:latest
    container_name: netsentry_collector
    restart: unless-stopped
    ports:
      - "2055:2055/udp"
      - "6343:6343/udp"
    volumes:
      - netflow_data:/data
    environment:
      - NETFLOW_PORT=2055
      - SFLOW_PORT=6343
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUX_TOKEN}
      - INFLUXDB_ORG=network-monitoring
      - INFLUXDB_BUCKET=traffic
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
    networks:
      - netsentry
    depends_on:
      influxdb:
        condition: service_healthy
      redis:
        condition: service_healthy

  # Backend API
  backend:
    image: renew78/netsentry-backend:latest
    container_name: netsentry_backend
    restart: unless-stopped
    environment:
      - MONGO_URL=mongodb://admin:${MONGO_PASSWORD}@mongodb:27017
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUX_TOKEN}
      - INFLUXDB_ORG=network-monitoring
      - INFLUXDB_BUCKET=traffic
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      - SNMP_COMMUNITY=public
    networks:
      - netsentry
    depends_on:
      mongodb:
        condition: service_healthy
      influxdb:
        condition: service_healthy
      redis:
        condition: service_healthy

  # Frontend
  frontend:
    image: renew78/netsentry-frontend:latest
    container_name: netsentry_frontend
    restart: unless-stopped
    networks:
      - netsentry
    depends_on:
      - backend

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: netsentry_nginx
    restart: unless-stopped
    ports:
      - "4000:80"
    configs:
      - source: nginx_config
        target: /etc/nginx/nginx.conf
    networks:
      - netsentry
    depends_on:
      - frontend
      - backend

networks:
  netsentry:
    driver: bridge

volumes:
  mongodb_data:
  influxdb_data:
  influxdb_config:
  redis_data:
  netflow_data:

configs:
  nginx_config:
    content: |
      events {
          worker_connections 1024;
      }

      http {
          # Basic settings
          sendfile on;
          tcp_nopush on;
          tcp_nodelay on;
          keepalive_timeout 65;
          types_hash_max_size 2048;

          # Logging
          access_log /var/log/nginx/access.log;
          error_log /var/log/nginx/error.log;

          # Gzip compression
          gzip on;
          gzip_vary on;
          gzip_min_length 10240;
          gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/javascript application/xml+rss application/json;

          upstream backend {
              server backend:8000;
          }

          upstream frontend {
              server frontend:80;
          }

          server {
              listen 80;
              server_name _;

              # Increase client body size for file uploads
              client_max_body_size 10M;

              # Fix for double /api/api/ requests from frontend
              location ~ ^/api/api/(.*)$$ {
                  rewrite ^/api/api/(.*)$$ /api/$$1 break;
                  proxy_pass http://backend:8000;
                  proxy_http_version 1.1;
                  proxy_set_header Host $$host;
                  proxy_set_header X-Real-IP $$remote_addr;
                  proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $$scheme;
                  proxy_read_timeout 90;
              }

              # API proxy to backend
              location /api/ {
                  proxy_pass http://backend;
                  proxy_http_version 1.1;
                  proxy_set_header Host $$host;
                  proxy_set_header X-Real-IP $$remote_addr;
                  proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $$scheme;
                  proxy_read_timeout 90;
              }

              # WebSocket support
              location /ws {
                  proxy_pass http://backend;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $$http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $$host;
                  proxy_set_header X-Real-IP $$remote_addr;
                  proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $$scheme;
                  proxy_read_timeout 86400;
              }

              # Frontend (default location)
              location / {
                  proxy_pass http://frontend;
                  proxy_http_version 1.1;
                  proxy_set_header Host $$host;
                  proxy_set_header X-Real-IP $$remote_addr;
                  proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $$scheme;
              }
          }
      }
